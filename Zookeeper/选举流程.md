myid：服务器启动时的标识

SID：服务器Id，用来标识一台zk集群中的机器，每台机器不能重复，和myid一致

ZXID：事务Id，用来标识一次服务器状态的变更。在某一时刻，集群中每台机器的ZXID不一定完全一致，但最终能一致。

Epoch：每个Leader任期的序号。



**选举的优先级，Epoch>ZXID>SID**，epoch大的直接胜出，epoch相同，则向后比较。



### 启动选举

假设集群有5台服务器

1、zk1启动，发起一次选举，zk1投自己1票。此时zk1票数不够半数（3票）以上，选举无法完成，zk1状态保持为**LOOKING**

2、zk2启动，再发起一次选举，zk1、zk2分别投自己一票，并交换选票信息，此时**zk1发现zk2的myid比自己目前投票的zk1大，所以更改选票为zk2**。zk1得0票，zk2得2票，但仍然没有达到半数以上，选举无法完成，两台服务器保持LOOKING

3、zk3启动，再发起一次选举，zk3的myid比zk1、zk2大，所以zk1得0票，zk2得0票，zk3得3票。此时zk3票数过半，成为leader，**zk1和zk2更改状态为FOLLOWING，zk3更改为LEADING**

4、zk4启动，再发起一次选举，此时**zk1、zk2、zk3已经不是LOOKING状态，不会更改选票信息**。zk4的myid比zk3大，所以将选票投给自己。zk3得3票，zk4得1票。**zk4服从多数，将选票信息更改为zk3，并更改状态为FOLLOWING**

5、zk5与zk4过程一致。



### 运行选举

运行期间发生选举，有两种情况，一是新节点加入，二是Leader失联。



#### 新节点加入

与启动选举类似，由于已经存在Leader，新节点在发起选举后，已有节点不会更改选票信息，所以新节点服从多数，将选票信息更改为对应的 leader。



#### Leader失联

leader失联，有可能是follower自身网络问题，导致没有连到leader。也有可能是leader已经挂掉了。



对于第一种，follower会发起一次选举，但集群中仍然存在leader，会被其他节点告知已有leader的地址，对于follower来说，会不停的重连leader，并进行同步。



第二种，假设zk集群有五个节点，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，并且，此时SID为3的zk是Leader。某一时刻，zk3\zk5出现故障，因此进行Leader选举。

此时，服务器节点为zk1、zk2、zk4，超过集群半数，能够选举出对应的Leader。

| 机器 | EPOCH | ZXID          | SID  |
| ---- | ----- | ------------- | ---- |
| zk1  | 1     | 8             | 1    |
| zk2  | 1     | **8（胜出）** | 2    |
| zk4  | 1     | 7             | 4    |

