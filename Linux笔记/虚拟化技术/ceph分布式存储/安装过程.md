### 部署架构





### 服务器环境

#### centos常规

- 固定ip，IP、DNS等只是示例
```shell
#/bin/bash

HOSTNAME="copy"
DNS1="192.168.19.2"
GATEWAY="192.168.19.2"
IPADDR="192.168.19.128"
NETMASK="255.255.255.0"

# 固定ip
echo "DNS1=\"${DNS1}\"" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "GATEWAY=\"${GATEWAY}\"" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "IPADDR=\"${IPADDR}\"" >> /etc/sysconfig/network-scripts/ifcfg-ens33
echo "NETMASK=\"${NETMASK}\"" >> /etc/sysconfig/network-scripts/ifcfg-ens33

# 设置hostname
hostnamectl set-hostname ${HOSTNAME}

systemctl restart network
```



- 更新源和内核、禁用防火墙和selinux

```shell
#/bin/bash
# 源
wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo

# 清楚yum缓存
yum clear all 
yum makecache

# 更新内核和lib
yum update -y 
# 更新常用软件
yum install git vim net-tools -y

# 关闭交换区
echo 0 | sudo tee /proc/sys/vm/swappiness
# overcommit
echo 1 | sudo tee /proc/sys/vm/overcommit_memory

# 关闭防火墙
systemctl stop firewall
# 禁止防火墙开机自启
systemctl disable firewall

# 关闭selinux
setenforce 0
# 永久关闭selinux
echo "SELINUX=disabled 
SELINUXTYPE=targeted" > /etc/selinux/config

# 重启
shutdown -r now
```


#### ceph配置

- 添加ceph源，以阿里云源为例

```sh
#/bin/bash
# 阿里云镜像地址
SOURCE="mirrors.aliyun.com"
# ceph版本
CEPH_VERSION="16.2.9"

echo "
[ceph]
name=ceph
baseurl=http://${SOURCE}/ceph/rpm-${CEPH_VERSION}/el7//x86_64/
gpgcheck=0
priority=1

[ceph-noarch]
name=cephnoarch
baseurl=http://${SOURCE}/ceph/rpm-${CEPH_VERSION}/el7//noarch/
gpgcheck=0
priority=1

[ceph-source]
name=Ceph source packages
baseurl=http://${SOURCE}/ceph/rpm-${CEPH_VERSION}/el7//SRPMS
gpgcheck=0
priority=1
" >> /etc/yum.repos.d/ceph.repo
```



- 配置hosts

```shell
echo "
192.168.19.130 admin
192.168.19.131 node1
192.168.19.132 node2
192.168.19.133 node3
192.168.19.134 client
" >> /etc/hosts
```


- 添加用户

```shell
user@local: useradd ceph
user@local: passwd ceph

user@local: visudo
# 添加下面的配置
ceph ALL=(root) NOPASSWD:ALL
```



- admin与其他服务器授权

```shell
ssh-copy-id ceph@node1
ssh-copy-id ceph@node2
ssh-copy-id ceph@node3
ssh-copy-id ceph@client
```



- 配置ceph-deploy

```shell
echo "
Host node1
Hostname node1
User ceph

Host node2
Hostname node2
User ceph

Host node2
Hostname node2
User ceph
" > ~/.ssh/config
```



- 安装时钟服务器

在admin节点执行

```shell
yum install -y ntp

vim /etc/ntp/ntp.conf
# 注释下面的服务器
# server 0.centos.pool.ntp.org iburst
# server 1.centos.pool.ntp.org iburst
# server 2.centos.pool.ntp.org iburst
# server 3.centos.pool.ntp.org iburst

# 添加下面两行
server 127.127.1.0
fudge 127.127.1.0

systemctl start ntpd
```



在其他节点执行

```shell
yum install -y ntpdate
ntpdate admin
```



- 安装epel-release及yum相关组件

```shell
yum -y install epel-release yum-plugin-priorities yum-utils
```



- 安装Ceph及相关组件

```sh
yum install -y ceph-deploy ceph ceph-radosgw snappy leveldb gdisk python-argparse gperftools-libs
```

